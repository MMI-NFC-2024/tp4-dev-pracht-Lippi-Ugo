---
import Layout from "../../layouts/Layout.astro";
import diamonds from "../../assets/diamond.json";
import GraphicDiamond from "../../components/GraphicDiamond.astro";
---

<Layout title="Diamond filtre">
  <form class="mb-6">
    <label for="cut" class="block text-sm font-semibold mb-2">Choisir un cut :</label>
    <select name="cut" id="cut" class="w-full max-w-xs border border-gray-300 rounded px-3 py-2">
      <option value="">Tous</option>
      {Array.from(new Set(diamonds.map(d => d.cut))).map(c => (
        <option value={c}>{c}</option>
      ))}
    </select>
  </form>

  <!-- SSR initial -->
  <GraphicDiamond title="Diamants - Filtre" containerId="diamondplot" />

  <script>
    import * as Plot from "@observablehq/plot";
    import diamonds from "../../assets/diamond.json";

    const selectCut = /** @type {HTMLSelectElement | null} */ (document.querySelector('#cut'));
    const plotDiv = /** @type {HTMLDivElement | null} */ (document.querySelector('#diamondplot'));

    function renderPlot() {
      const cut = selectCut ? selectCut.value : '';
      const filtered = diamonds.filter(d => (!cut || d.cut === cut));

      if (!plotDiv) return;
      plotDiv.innerHTML = '';

      const plot = Plot.plot({
        marks: [
          Plot.dot(filtered, { x: 'carat', y: 'price', stroke: 'cut' })
        ],
        x: { label: 'Carat' },
        y: { label: 'Price' },
        width: 700,
        height: 400,
      });

      plotDiv.append(plot);
    }

    if (selectCut) selectCut.addEventListener('change', renderPlot);
    renderPlot();
  </script>
</Layout>
